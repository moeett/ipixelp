<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iPixel Productions - Creating Immersive 3D & Animation Experiences</title>
    <meta name="description" content="iPixel Productions specializes in 3D animation, interactive experiences, and immersive digital content that brings your vision to life with cutting-edge technology.">
    
    <!-- Critical Performance Optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://prod.spline.design" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Inline Critical CSS to prevent render blocking -->
    <style>
      /* Critical CSS for initial render */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #000;
        color: #fff;
        overflow-x: hidden;
      }
      
      /* Loading state styles */
      .loading-container {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
        z-index: 9999;
        transition: opacity 0.3s ease;
      }
      
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Spline viewer optimization */
      spline-viewer {
        display: block;
        width: 100%;
        height: 100vh;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      
      spline-viewer.loaded {
        opacity: 1;
      }
      
      /* Hide inactive viewers */
      .hero-desktop { display: block; }
      .hero-mobile { display: none; }
      
      @media (max-width: 768px) {
        .hero-desktop { display: none; }
        .hero-mobile { display: block; }
      }
      
      /* Prevent layout shift */
      .hero-section {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }
    </style>
    
    <!-- Defer non-critical fonts -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
  </head>
  <body>
    <!-- Loading indicator -->
    <div class="loading-container" id="loadingIndicator">
      <div class="loading-spinner"></div>
    </div>
    
    <div id="root"></div>
    
    <!-- Optimized Spline viewer loading script -->
    <script>
      // Performance optimization configuration
      window.PERFORMANCE_CONFIG = {
        enableSpline: true,
        lazyLoadDelay: 100,
        webglRetryAttempts: 3,
        webglRetryDelay: 500
      };
      
      // Early WebGL context check
      function checkWebGLSupport() {
        try {
          const canvas = document.createElement('canvas');
          const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
          return !!gl;
        } catch (e) {
          return false;
        }
      }
      
      // Initialize performance monitoring
      if ('PerformanceObserver' in window) {
        const perfObserver = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'largest-contentful-paint') {
              console.log('LCP:', entry.startTime);
            }
          }
        });
        perfObserver.observe({ entryTypes: ['largest-contentful-paint'] });
      }
      
      // Defer Spline loading until critical resources are ready
      window.addEventListener('DOMContentLoaded', () => {
        const hasWebGL = checkWebGLSupport();
        
        if (!hasWebGL) {
          console.warn('WebGL not supported. Disabling 3D content.');
          window.PERFORMANCE_CONFIG.enableSpline = false;
          document.getElementById('loadingIndicator').style.display = 'none';
          return;
        }
        
        // Load Spline runtime with error handling
        const splineScript = document.createElement('script');
        splineScript.type = 'module';
        splineScript.src = 'https://unpkg.com/@splinetool/viewer@1.0.54/build/spline-viewer.js';
        splineScript.async = true;
        
        splineScript.onload = () => {
          console.log('Spline runtime loaded');
          // Defer viewer initialization
          requestIdleCallback(() => initializeSplineViewers(), { timeout: 2000 });
        };
        
        splineScript.onerror = () => {
          console.error('Failed to load Spline runtime');
          window.PERFORMANCE_CONFIG.enableSpline = false;
          document.getElementById('loadingIndicator').style.display = 'none';
        };
        
        document.head.appendChild(splineScript);
      });
      
      // Optimized Spline viewer initialization
      function initializeSplineViewers() {
        const isMobile = window.innerWidth <= 768;
        const viewerId = isMobile ? 'hero-mobile-viewer' : 'hero-desktop-viewer';
        
        // Create viewer element dynamically to prevent unnecessary loading
        const heroSection = document.querySelector('.hero-section');
        if (!heroSection) return;
        
        const viewer = document.createElement('spline-viewer');
        viewer.id = viewerId;
        viewer.className = isMobile ? 'hero-mobile' : 'hero-desktop';
        viewer.setAttribute('url', isMobile 
          ? 'https://prod.spline.design/7OY7EQbLmGFXXEXJ/scene.splinecode'
          : 'https://prod.spline.design/IhqVDRC-d2KKlG6p/scene.splinecode'
        );
        
        // Set loading strategy
        viewer.setAttribute('loading', 'lazy');
        viewer.setAttribute('fps', '30'); // Limit FPS for better performance
        
        // WebGL error handling
        let retryCount = 0;
        const maxRetries = window.PERFORMANCE_CONFIG.webglRetryAttempts;
        
        function handleWebGLError() {
          if (retryCount < maxRetries) {
            retryCount++;
            console.log(`Retrying WebGL initialization (${retryCount}/${maxRetries})`);
            setTimeout(() => {
              viewer.remove();
              initializeSplineViewers();
            }, window.PERFORMANCE_CONFIG.webglRetryDelay);
          } else {
            console.error('WebGL initialization failed after retries');
            fallbackToStaticContent();
          }
        }
        
        // Monitor for WebGL errors
        viewer.addEventListener('error', handleWebGLError);
        
        // Monitor load completion
        viewer.addEventListener('load', () => {
          console.log('Spline viewer loaded successfully');
          viewer.classList.add('loaded');
          document.getElementById('loadingIndicator').style.opacity = '0';
          setTimeout(() => {
            document.getElementById('loadingIndicator').style.display = 'none';
          }, 300);
        });
        
        // Ensure proper sizing before rendering
        requestAnimationFrame(() => {
          heroSection.appendChild(viewer);
        });
      }
      
      // Fallback for WebGL failures
      function fallbackToStaticContent() {
        const heroSection = document.querySelector('.hero-section');
        if (heroSection) {
          heroSection.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);">
              <div style="text-align: center; padding: 2rem;">
                <h1 style="font-size: 3rem; margin-bottom: 1rem;">iPixel Productions</h1>
                <p style="font-size: 1.2rem; opacity: 0.8;">Creating Immersive Digital Experiences</p>
              </div>
            </div>
          `;
        }
        document.getElementById('loadingIndicator').style.display = 'none';
      }
      
      // Optimize resize handling
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const viewer = document.querySelector('spline-viewer');
          if (viewer) {
            const shouldBeMobile = window.innerWidth <= 768;
            const isMobileViewer = viewer.classList.contains('hero-mobile');
            
            if (shouldBeMobile !== isMobileViewer) {
              viewer.remove();
              initializeSplineViewers();
            }
          }
        }, 250);
      });
    </script>
    
    <!-- Main app module -->
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
